#!/bin/bash

# Install and remove packages
add-apt-repository -y ppa:webupd8team/sublime-text-3
sed -i 's/ main / main universe multiverse /g' /etc/apt/sources.list
apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF
echo "deb http://download.mono-project.com/repo/debian wheezy main" | tee /etc/apt/sources.list.d/mono-xamarin.list
apt-get update
apt-get -y install build-essential vim vim-gtk emacs sublime-text-installer idle-python2.7 idle-python3.4 eclipse eclipse-cdt-valgrind monodevelop gedit-developer-plugins gedit-plugins anjuta-extras geany-plugins clang-3.5 virtualbox-guest-dkms virtualbox-guest-x11
apt-get -y purge thunderbird libreoffice-core empathy rhythmbox shotwell transmission-gtk simple-scan aisleriot gnome-sudoku gnome-mahjongg gnomine unity-webapps-common software-center landscape-client-ui-install unity-control-center-signon ubiquity gparted remmina
apt-get -y autoremove
apt-get -y upgrade

# Install firewall, blocking all external IPs except domserver.cosc.canterbury.ac.nz (132.181.7.114) and dmjappprd01.sit.auckland.ac.nz (130.216.8.43)
# Modify the two lines before "COMMIT" to restrict the IPs of the printers allowed
apt-get -y install iptables-persistent
cat << EOF_IPTABLERULES > /etc/iptables/rules.v4
# Generated by iptables-save v1.4.21 on Thu Aug  6 13:24:05 2015
*filter
:INPUT DROP [652:124986]
:FORWARD ACCEPT [0:0]
:OUTPUT DROP [2784:493258]
-A INPUT -i lo -j ACCEPT
-A OUTPUT -o lo -j ACCEPT
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A OUTPUT -p udp -m udp --dport 53 -j ACCEPT
-A OUTPUT -d 132.181.7.114/32 -p tcp -m tcp --dport 80 -j ACCEPT
-A OUTPUT -d 130.216.8.43/32 -p tcp -m tcp --dport 80 -j ACCEPT
-A OUTPUT -p udp -m udp --dport 631 -j ACCEPT
-A OUTPUT -p tcp -m tcp --dport 631 -j ACCEPT
COMMIT
# Completed on Thu Aug  6 13:24:05 2015
EOF_IPTABLERULES

# Setup printers
# THIS IS A TEST CONFIGURATION FILE FOR PRINTING AT UWA
# PLEASE MODIFY THIS
# ADDITIONALLY, PLACE THE PRINTER'S PPD IN /etc/cups/ppd/
cat << EOF_PRINTER > /etc/cups/printers.conf
# Printer configuration file for CUPS v1.7.2
# Written by cupsd
# DO NOT EDIT THIS FILE WHEN CUPSD IS RUNNING
<DefaultPrinter 205>
UUID urn:uuid:6d6b9a28-750b-3713-5352-627c5f213590
Info HP LaserJet 4350
Location Lab 2.05
DeviceURI ipp://130.95.116.32
PPDTimeStamp *
State Idle
StateTime 1439606521
Type 8425668
Accepting Yes
Shared Yes
ColorManaged Yes
JobSheets none none
QuotaPeriod 0
PageLimit 0
KLimit 0
OpPolicy default
ErrorPolicy retry-job
</Printer>
EOF_PRINTER

# Cleanup example content, and place useful links instead
rm -r /usr/share/example-content/*
cat << EOF_BACKUPSERVER > /usr/share/example-content/backup_server.desktop
[Desktop Entry]
Encoding=UTF-8
Name=Backup DOMJudge Server
Type=Link
URL=http://dmjappprd01.sit.auckland.ac.nz/domjudge/team/
Icon=text-html
EOF_BACKUPSERVER
cat << EOF_DOCURL > /usr/share/example-content/documentation.desktop
[Desktop Entry]
Encoding=UTF-8
Name=Language References
Type=Link
URL=http://domserver.cosc.canterbury.ac.nz/contestantdocs/
Icon=text-html
EOF_DOCURL
cat << EOF_SAMPLEDATA > /usr/share/example-content/Sample_Data.html
<!DOCTYPE HTML>
<html>
<head>
<title>Sample Data Links</title>
</head>
<body>
<ul>
<li><a href="http://domserver.cosc.canterbury.ac.nz/sampledata-west.zip">West</a></li>
<li><a href="http://domserver.cosc.canterbury.ac.nz/sampledata-east.zip">East</a></li>
<li><a href="http://domserver.cosc.canterbury.ac.nz/sampledata-central.zip">Central</a></li>
</ul>
</body>
</html>
EOF_SAMPLEDATA

# Set Firefox homepage to http://domserver.cosc.canterbury.ac.nz/domjudge/team/
cat << EOF_FIREPREFS > /usr/lib/firefox/defaults/pref/all.corp.js
lockPref("browser.startup.homepage","http://domserver.cosc.canterbury.ac.nz/domjudge/team/");
EOF_FIREPREFS

# Set timezone to Australia/Perth - Modify as necessary
echo "Australia/Perth" | tee /etc/timezone
dpkg-reconfigure --frontend noninteractive tzdata

# Remove sudo access
rm -fr /etc/sudoers.d
sed -r -i '/%admin|%sudo/ s/^/#/' /etc/sudoers
