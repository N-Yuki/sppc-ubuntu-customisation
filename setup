#!/bin/bash

# Install and remove packages
dpkg-divert --local --add /etc/init.d/systemd-logind
ln -s /bin/true /etc/init.d/systemd-logind
add-apt-repository -y ppa:webupd8team/sublime-text-3
sed -i 's/ main / main universe multiverse /g' /etc/apt/sources.list
apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF
echo "deb http://download.mono-project.com/repo/debian wheezy main" | tee /etc/apt/sources.list.d/mono-xamarin.list
apt-get update
apt-get -y install build-essential vim vim-gtk emacs sublime-text-installer idle-python2.7 idle-python3.4 eclipse eclipse-cdt-valgrind monodevelop gedit-developer-plugins gedit-plugins anjuta-extras geany-plugins
apt-get -y purge thunderbird libreoffice-core empathy rhythmbox shotwell transmission-gtk simple-scan aisleriot gnome-sudoku gnome-mahjongg gnomine unity-webapps-common software-center landscape-client-ui-install unity-control-center-signon ubiquity gparted remmina
apt-get -y autoremove
apt-get -y upgrade

# Install firewall, blocking all external IPs except domserver.cosc.canterbury.ac.nz (132.181.7.114) and dmjappprd01.sit.auckland.ac.nz (130.216.8.43)
# Modify this to allow IP printers by adding lines just before "COMMIT"
apt-get -y install iptables-persistent
cat << EOF_IPTABLERULES > /etc/iptables/rules.v4
# Generated by iptables-save v1.4.21 on Thu Aug  6 13:24:05 2015
*filter
:INPUT DROP [652:124986]
:FORWARD ACCEPT [0:0]
:OUTPUT DROP [2784:493258]
-A INPUT -i lo -j ACCEPT
-A OUTPUT -o lo -j ACCEPT
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A OUTPUT -p udp -m udp --dport 53 -j ACCEPT
-A OUTPUT -d 132.181.7.114/32 -p tcp -m tcp --dport 80 -j ACCEPT
-A OUTPUT -d 130.216.8.43/32 -p tcp -m tcp --dport 80 -j ACCEPT
COMMIT
# Completed on Thu Aug  6 13:24:05 2015
EOF_IPTABLERULES

# Cleanup example content, and put a link to the backup server instead
rm -r /usr/share/example-content/*
cat << EOF_BACKUPSERVER > /usr/share/example-content/backup_server.desktop
[Desktop Entry]
Encoding=UTF-8
Name=Backup DOMJudge Server
Type=Link
URL=http://dmjappprd01.sit.auckland.ac.nz/domjudge/team/
Icon=text-html
EOF_BACKUPSERVER

# Set Firefox homepage to http://domserver.cosc.canterbury.ac.nz/domjudge/team/
cat << EOF_FIREPREFS > /usr/lib/firefox/defaults/pref/all.corp.js
lockPref("browser.startup.homepage","http://domserver.cosc.canterbury.ac.nz/domjudge/team/");
EOF_FIREPREFS

# Remove sudo access
rm -fr /etc/sudoers.d
sed -r -i '/%admin|%sudo/ s/^/#/' /etc/sudoers
